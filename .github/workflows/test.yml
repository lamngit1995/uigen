name: Test CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Cache Prisma
      uses: actions/cache@v4
      with:
        path: |
          node_modules/.prisma
          src/generated/prisma
        key: ${{ runner.os }}-prisma-${{ hashFiles('prisma/schema.prisma') }}
        restore-keys: |
          ${{ runner.os }}-prisma-

    - name: Install dependencies
      run: npm ci

    - name: Setup test environment
      run: |
        echo "Setting up test environment..."
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

    - name: Generate Prisma client
      run: npx prisma generate

    - name: Setup test database
      run: |
        echo "Setting up test database..."
        npx prisma migrate deploy || echo "No migrations to apply"
        ls -la prisma/ || true

    - name: Run linter
      run: npm run lint

    - name: Run tests
      run: npm test -- --reporter=verbose --no-coverage --run
      env:
        NODE_ENV: test
        CI: true
        FORCE_COLOR: 1

    - name: Upload test results on failure
      if: failure()
      run: |
        echo "Tests failed. Environment info:"
        echo "Node: $(node --version)"
        echo "NPM: $(npm --version)"
        echo "Platform: $(uname -a)"
        echo "PWD: $(pwd)"
        ls -la

    - name: Build project
      run: npm run build

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.node-version }}
        path: .next
        retention-days: 1

    - name: Test build artifacts
      run: |
        if [ -d ".next" ]; then
          echo "‚úÖ Build successful - .next directory exists"
          ls -la .next
        else
          echo "‚ùå Build failed - .next directory not found"
          exit 1
        fi

  verify-installation:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify repository structure
      run: |
        echo "üìÅ Repository Structure:"
        echo "======================="
        ls -la
        echo ""
        echo "üì¶ Package Information:"
        echo "======================="
        cat package.json | grep -E '"name"|"version"'
        echo ""
        echo "‚úÖ Repository verification complete!"

    - name: Check GitHub context
      run: |
        echo "üîç GitHub Context:"
        echo "==================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Event: ${{ github.event_name }}"
        echo "Actor: ${{ github.actor }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run Number: ${{ github.run_number }}"
        echo ""
        echo "‚úÖ GitHub Actions is working properly!"
